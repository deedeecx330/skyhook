#!/usr/bin/env python3

import os, sys, db, updown, config

def main(command, target):

    if command == "list" and target == "history":
        db.listDb()

    elif command == "clear" and target == "history":
        db.clearDb()

    elif command == "search":
        db.searchDb(target)

    elif command == "add":
        name, hash, key = target.split(':')
        res = db.addEntry(name, hash, key)
        if res == 1:
            print("[!] Error adding entry to history")
        elif res == 2:
            print("[!] Invalid hash")
        elif res == 3:
            print("[!] Unacceptable key length")
        else:
            print("[+] Successfully added {}".format(name))

    elif command == "export":
        res = db.exportDb(target)
        if res == 1:
            print("[!] Error exporting history to {}".format(target))
        else:
            print("[+] Successfully exported history to {}".format(target))

    elif command == "save":
        res = db.saveOne(target)
        if res == 1:
            print("[!] Could not find {} in local history".format(target))
        elif res == 2:
            print("[!] Error saving {} to local directory".format(target))
        else:
            print("[+] Successfully saved {} to local directory".format(target))

    elif command == "import":
        res = db.importDb(target)
        if res == 1:
            print("[!] Could not read {}".format(target))
        elif res == 2:
            print("[!] Could not import {}".format(target))
        elif res == 3:
            print("[!] No entries in {}".format(target))
        else:
            print("[+] Successfully imported {}".format(target))

    elif command == "delete":
        res = db.deleteItem(target)
        if res == 1:
            print("[!] Could not find {} in history".format(target))
        elif res == 2:
            print("[!] Could not delete {} from history".format(target))
        else:
            print("[+] Successfully deleted {} from history".format(target))

    elif command == "upload":
        res = updown.uploadFile(target)
        if res == 1:
            print("[!] Could not find {}".format(target))
        elif res == 2:
            print("[!] Could not encrypt {}".format(target))
        elif res == 3:
            print("[!] Could not upload {}".format(target))
        elif res == 4:
            print("[!] Could not add an entry for {}".format(target))
        else:
            print("[+] Successfully uploaded {}".format(target))

    elif command == "download":
        res = updown.downloadFile(target)
        if res == 1:
            print("[!] Could not retrieve {} from history".format(target))
        elif res == 2:
            print("[!] Could not download {}".format(target))
        elif res == 3:
            print("[!] Could not decrypt {}".format(target))
        else:
            print("[+] Downloaded {} successfully".format(res))
                
    else:
        print(config.usage)

if __name__ == "__main__":

    if len(sys.argv) != 3:
        print(config.usage)
        exit()

    command = str(sys.argv[1])
    target = str(sys.argv[2])
    workDir = os.getcwd()
    
    for tar in target.split(','):
        os.chdir(workDir)
        main(command, tar.strip()) 
